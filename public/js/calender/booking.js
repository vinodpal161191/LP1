!function(a){var b=function(e,d){this.element=a(e);this.url=d.url;if(!this.url){console.error("No url")}this.startDate=d.startDate;this.endDate=d.endDate||Vaya.DateTime.addUTC(new Date(),0,3,0);this.selectedDay=d.selectedDay;this.selectedTimeValue=d.selectedTimeLabel;this.data={};this.datepickerEnabled=!d.mobile;this.dateElement=this.element.find(".booking-input-date");if(this.datepickerEnabled){this.dateElement.datepicker({format:Vaya.DateTimePicker.pickerDateFormat,todayBtn:"linked",autoclose:true,startDate:this.startDate,endDate:this.endDate,beforeShowDay:a.proxy(this.datepickerBeforeShowDay,this)})}this.quantityElement=this.element.find(".booking-input-quantity");this.errorElement=this.element.find(".booking-error");this.errorLoadingElement=this.element.find(".booking-loading-error");this.timeElement=this.element.find(".booking-timepicker");this.timepicker=this.timeElement.find(".booking-timepicker-input");this.timepicker.timepicker({timeFormat:Vaya.DateTimePicker.pickerTimeFormat,maxTime:"11:30 PM",scrollDefaultNow:true});if(!!this.selectedTimeValue){this.timepicker.timepicker("setTime",Vaya.DateTime.parseTime(this.selectedTimeValue))}this.error=a.proxy(function(){this.element.find(".booking-loading-error").show()},this);if(!!this.selectedDay){this.setUTCDate(this.selectedDay)}else{var c=new Date();this.setUTCDate(new Date(c.getFullYear(),c.getMonth(),c.getDate()))}this._attachEvents();this.refresh()};b.prototype={constructor:b,_attachEvents:function(){if(this.datepickerEnabled){this.element.on("changeDate",a.proxy(function(d){this.dateElement.datepicker("setUTCDate",d.date)},this))}if(this.datepickerEnabled){this.dateElement.on("changeDate",a.proxy(function(e){var d=this.dateElement.data("datepicker").getDate();this._setUTCDate(d)},this))}else{var c=function(e){var f=this.dateElement.val();if(!!f){var d=Vaya.DateTimePicker.parseDate(f,null,true);this._setUTCDate(d)}};this.dateElement.on("click",a.proxy(c,this));this.dateElement.on("change",a.proxy(c,this))}this.element.find(".booking-header").click(a.proxy(function(){this.dateElement.focus()},this));this.element.find(".booking-quantity-dropdown .dropdown-menu a").on("click",a.proxy(function(d){var e=d.target||d.srcElement;this.quantityElement.val(a(e).text())},this));this.timepicker.change(a.proxy(function(){this.setSelectedTimeValue(this.timepicker.val())},this));this.dateElement.on("change",a.proxy(function(){var d=Vaya.DateTime.formatISO8601DayOnly(this.date);this.updateHistory({d:d})},this));this.element.delegate("input","change",a.proxy(function(){this.clearErrors()},this));this.element.find("form").submit(a.proxy(function(h){this.clearErrors();var g=parseInt(this.quantityElement.val(),10);var d=parseInt(this.element.find(".booking-input").data("remaining"),10);if(g>d){h.preventDefault();var f="Only "+d+" spots remaining for this time. Try another time?";if(d<1){f="No spots remaining for this time. Try another time?"}this.errorElement.find("p").text(f);this.errorElement.show()}},this))},getURLParameter:function(c){return decodeURIComponent((new RegExp("[?|&]"+c+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null},updateHistory:function(c){c.d=c.d||this.getURLParameter("d");c.t=c.t||this.getURLParameter("t");if(!c.d){delete c.d}if(!c.t){delete c.t}var d=a(document).attr("title");window.History.replaceState(c,d,"?"+a.param(c))},clearErrors:function(){this.errorLoadingElement.hide();this.errorElement.hide()},datepickerBeforeShowDay:function(d){var e=Vaya.DateTime.formatISO8601DayOnly(d);var f=this.data.busy?this.data.busy[e]:null;if(!!f&&f[0]==null&&f[1]==null){return[true,"busy"]}var c=this.data.events?this.data.events[e]:null;if(!!c){return[true,"event"]}return[true,null]},_setUTCDate:function(c){this.date=c;this.fill()},setUTCDate:function(c,e){this._setUTCDate(c);if(this.datepickerEnabled){this.element.trigger({type:"changeDate",date:this.date})}else{var d=Vaya.DateTime.formatISO8601DayOnly(this.date);this.dateElement.val(d)}if(!!e){this.updateHistory({d:Vaya.DateTime.formatISO8601DayOnly(this.date)})}},update:function(){this.setUTCDate(this.date)},setLoading:function(c){if(c){this.element.find(".booking-loading").show();this.element.find(".booking-loading-hide").hide();this.element.find(".booking-items").hide()}else{this.element.find(".booking-loading").hide();this.element.find(".booking-loading-hide").show();this.element.find(".booking-items").show()}},setBookNowEnabled:function(c){if(c){this.element.find(".booking-button-now").show();this.element.find(".booking-button-unavailable").hide()}else{this.element.find(".booking-button-now").hide();this.element.find(".booking-button-unavailable").show()}},_zeroPad:function(c){return c<10?"0"+c:""+c},_ampmHour:function(c){return c==12?12:(c==0?12:(c>12?c%12:c))},timeSelect:function(h,c,s){var p=['<select name="reservation_request_time" style="width: 150px; font-size: 16px;">'];var g=9;var t=24;var j=g*2;var n=t*2;c=c||0;s=s||1440;p.push('<option value=""></option>\n');for(var f=0;f<n;f++){var l=((f+j)%n)*30;if(l<c){continue}if(l>s){break}var e=Math.floor(l/60);var k=l<720?" AM":" PM";var m=this._zeroPad(l%60);var d=this._ampmHour(e);var r=this._zeroPad(d);var o=d+":"+m+k;var q=r+":"+m+k;if(h==q){p.push('<option value="'+q+'" selected="selected">'+o+"</option>\n")}else{p.push('<option value="'+q+'">'+o+"</option>\n")}}p.push("</select>");return p},setSelectedTimeValue:function(c){this.selectedTimeValue=c;this.updateHistory({t:c})},updateTimeSelect:function(c,i,j){var e=this.element.find(".booking-timepicker-select");if(e.length>0){c=c||this.selectedTimeValue;var h=i?Vaya.DateTime.getMinutesSinceMidnight(i):null;var g=i?Vaya.DateTime.getMinutesSinceMidnight(j):null;var f=this.timeSelect(c,h,g);e.html(f.join(""));var d=a(e[0].firstChild);d.change(a.proxy(function(){this.setSelectedTimeValue(d.val())},this))}},fill:function(){if(!this.data.events){return}var u=Vaya.DateTime.formatISO8601DayOnly(this.date);var r=this.data.events[u]||{events:[]};var g=r.events.length;this.element.find(".booking-busy").hide();this.timeElement.hide();this.element.find(".booking-times").empty();this.setBookNowEnabled(true);this.timepicker.timepicker("option","minTime","12:00 AM");this.timepicker.timepicker("option","maxTime","11:30 PM");this.element.find(".booking-timepicker-help").hide();var s=this.data.busy[u];if(!!s&&g==0){if(s[0]==null&&s[1]==null){this.element.find(".booking-busy").show();this.setBookNowEnabled(false);return}this.timeElement.show();this.previousTime=this.timepicker.timepicker("getTime");if(!!s[1]){var m=Vaya.DateTime.parseISO8601(s[1],true);var d=Vaya.DateTime.formatTimeFromISO8601(s[1]);this.timepicker.timepicker("option","minTime",d);this.timepicker.timepicker("setTime",m);this.updateTimeSelect(d,m);var n=this.element.find(".booking-timepicker-help");n.text("Available after "+d);n.show()}else{if(!!s[0]){var t=Vaya.DateTime.parseISO8601(s[0],true);var d=Vaya.DateTime.formatTimeFromISO8601(s[0]);this.timepicker.timepicker("option","maxTime",d);this.timepicker.timepicker("setTime",t);this.updateTimeSelect(null,null,t);var n=this.element.find(".booking-timepicker-help");n.text("Available before "+d);n.show()}}return}this.updateTimeSelect();if(r.events.length==0){this.timeElement.show();if(!!this.previousTime){this.timepicker.timepicker("setTime",this.previousTime);this.previousTime=null}return}this.element.find(".booking-table").show();var j=[];var e=0;for(var q=0;q<r.events.length&&!!this.selectedTimeValue;q++){var d=Vaya.DateTime.formatTimeFromISO8601(r.events[q].start);if(this.selectedTimeValue.toUpperCase()==d.toUpperCase()){e=q;break}}if(g==1){var p=r.events[0];var h=Vaya.DateTime.formatTimeFromISO8601(p.start);var d=h;var k=p.data.quantity_max-(o+f);var c=p.start;j.push('<label class="booking-time-1" for="'+c+'">');j.push('<input  type="hidden" data-remaining="'+k+'" name="reservation_confirm_time" value="'+h+'" class="booking-input" id="'+c+'">');j.push(d);j.push("</label>")}else{j.push('<table class="table-condensed booking-table">');j.push('<tbody class="booking-items">');for(var q=0;q<r.events.length;q++){var p=r.events[q];var h=Vaya.DateTime.formatTimeFromISO8601(p.start);var d=h;var o=p.data.quantity_confirmed||0;var f=p.data.quantity_pending||0;var k=p.data.quantity_max-(o+f);var c=p.start;var l=(q==e);if(l){j.push('<tr class="booking-selected"><td>')}else{j.push("<tr><td>")}j.push('<label class="booking-time radio" for="'+c+'">');j.push('<input  type="radio" data-remaining="'+k+'" name="reservation_confirm_time" value="'+h+'" class="booking-input" id="'+c+'"'+(l?" checked":"")+">");j.push(d);j.push("</label></td></tr>")}j.push("</tbody></table>")}this.element.find(".booking-times").append(j.join(""));this.element.find(".booking-input").on("click",a.proxy(function(i){this.element.find(".booking-items tr").removeClass("booking-selected");var v=i.target||i.srcElement;a(v).parent().parent().parent().addClass("booking-selected")},this))},setData:function(e){this.data=e;if(!this.selectedDay){var c=e.date;if(!!c){var d=Vaya.DateTime.parseISO8601(c,true);this.setUTCDate(d)}}this.update();this.element.trigger({type:"setData",data:e})},refresh:function(){this.clearErrors();this.setLoading(true);a.ajax({url:this.url,cache:false,success:a.proxy(function(d,c,e){this.setData(d);this.setLoading(false)},this),error:this.error})}};a.fn.booking=function(d){var c=Array.apply(null,arguments);c.shift();return this.each(function(){var g=a(this),f=g.data("booking"),e=typeof d=="object"&&d;if(!f){g.data("booking",(f=new b(this,a.extend({},a.fn.booking.defaults,e))))}if(typeof d=="string"&&typeof f[d]=="function"){f[d].apply(f,c)}})};a.fn.booking.defaults={};a.fn.booking.Constructor=b}(window.jQuery);